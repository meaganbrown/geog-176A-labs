---
title: "Geography 176A"
author: "[Meagan Brown](https://meaganbrown.github.io)"
subtitle: 'Lab 04: Tesselations, Point-in-Ploygon'
output:
  html_document:
  theme: darkly
---
# Question 1
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
#1.1
library(sf)
library(tidyverse)
library(USAboundaries)
library(dplyr)
library(leaflet)


USAboundaries::us_counties(resolution = "low")


conus <- us_states() %>%
  filter(!(state_name %in% c('Puerto Rico', 'Alaska', 'Hawaii'))) %>% 
  st_as_sf(coords = c("lng","lat"), crs = 5326) %>%  
  st_transform(5070)



```



```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#1.2

library(rmapshaper)
conus_simp = ms_simplify(conus, keep = 0.05)
 
get_conus = function(data, var)
  {filter(data, !get(var) %in%
c("Hawaii", "Puerto Rico", "Alaska"))}

counties = st_transform(us_counties(), 5070) %>%
get_conus("state_name") %>% 
st_as_sf()

centroids = st_centroid(counties) 

centroids_union = centroids %>% 
  st_union

```


```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#1.3

 voroni = st_voronoi(centroids_union) %>% 
  st_cast() %>% 
  st_as_sf() %>% 
  mutate(id = 1:n())

triangulate = st_triangulate(centroids_union) %>% 
  st_cast() %>% 
  st_as_sf() %>% 
  mutate(id = 1:n())

sq_grid = st_make_grid(counties, n = 70) %>% 
  st_as_sf() %>% 
  mutate(id = 1:n())

hex_grid = st_make_grid(counties, n = 70, square = FALSE) %>% 
  st_as_sf() %>% 
  mutate(id = 1:n())

```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#1.4
states <- us_states() %>%
  filter(name != "Alaska" & name != "Puerto Rico" & name != "Hawaii") %>% 
  st_union() %>% 
  st_transform(5070)

plot(states)
mapview::npts(states)
```

>Continental US with all vertices retained



```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#1.5

us_simp = rmapshaper::ms_simplify(states, keep = 0.08)

plot(us_simp)
mapview::npts(us_simp)

voroni = st_intersection(voroni, st_union(us_simp))
triangulate = st_intersection(triangulate, st_union(us_simp))
```

>Continental US with 8% of vertices retained

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#1.6

plot_tess = function(data, title){
  ggplot() + 
    geom_sf(data = data, fill = "white", col = "navy", size = .2) +   
    theme_void() +
    labs(title = title, caption = paste("This tesselation has:", nrow(data), "tiles" )) +
    theme(plot.title = element_text(hjust = .5, color =  "navy", face = "bold"))
}
```

>I was able to remove 2973 points. Computationally, having less points allows for running code to load faster and better data analysis.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#1.7 (1)
plot_tess(counties, "Counties")
```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#1.7 (2)
plot_tess(voroni, "Voronoi Coverage")
```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#1.7 (3)
plot_tess(triangulate, "Delaunay Triangulation Coverage")
```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#1.7 (4)
plot_tess(sq_grid, "Square Coverage")
```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#1.7 (5)
plot_tess(hex_grid, "Hexegonal Coverage")
```



# Question 2

> The standard deviation of hexagon and grid are both equal to zero. This is due to the fact that these specific tessellations split the continental United States into equal area tiles of either squares or hexagons. The MAUP problem is a source of statistical bias that can signifcantly impact the results of a statistical hypothesis test. Comment on the influence of the tessellated surface in the visualization of point counts. The large scale of triangulation having 6,226 elements and hexagon only having 2,271 can impact the grouping and analysis of the data.


```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(knitr)
sum_tess = function(data, title) 
  {area = st_area(data) %>% 
    units::set_units("km2") %>%
    units::drop_units() 
  
  data_frame(title, nrow(data), mean(area), sd(area), sum(area)) }
tess_summary = bind_rows(
  sum_tess(counties, "Counties"),
  sum_tess(voroni, "Voroni"),
  sum_tess(triangulate, "Triangulation"),
  sum_tess(sq_grid, "Grid"),
  sum_tess(hex_grid, "Hexagon"))


knitr::kable(tess_summary,
caption = "Tessellation Characteristics",
col.names = c("Type","Elements","Mean Area (km2)","Standard Deviation Area (km2)","Coverage Area"),
format.args = list(big.mark = ",")) %>%
kableExtra::kable_styling("striped", full_width = TRUE, font_size = 14)
```

# Question 3

>Based on visualization, you can see that Voroni and Triangulation have different sized tiles due to different areas. On the other hand, Grid and Hexagon have equal sized tiles across the continental US. These differences in visualization influence data such as the MAUP problem by representing the same data in different ways and producing different results. This is why it is important to consider your specific data when choosing how to best analyze and represent it. Triangulation may be good for analyzing one set of data but not another. 

>Moving forward, I will use Hexagon as my tessellation for the dam data because it is able to cover the most area with the least amount of elements and will hopefully have the most accuracy. 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#3.1
library(readxl)
dam2019 <- read_excel("~/Documents/github/geog-176A-labs/data/NID2019_U.xlsx") %>% 
  filter(!is.na(LONGITUDE)) %>% 
  filter(!is.na(LATITUDE))

sf_dam <- dam2019%>% 
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326) %>%
  st_transform(5070)

```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#3.2

library(ggplot2)
library(plotrix)

point_in_polygon = function(points, polygon, id)
  {st_join(polygon, points) %>%
    st_drop_geometry() %>%
    dplyr::count(.data[[id]]) %>%
    setNames(c(id, "n")) %>%
    left_join(polygon, by = id) %>%
    st_as_sf()}

plot_pip = function(data, title)
  {ggplot() +
    geom_sf(data = data, aes(fill = log(n)), alpha = .9, size = .2, col = NA) +
    scale_fill_viridis_c() +
    theme_dark() +
    theme(legend.position = 'none',
          plot.title = element_text(face = "bold", color = "black", hjust = .5, size = 18)) +
    labs(title = title,
         caption = paste0(sum(data$n), " dams "))}



```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#3.3(1)
point_in_polygon(sf_dam, counties, "geoid") %>% 
  plot_pip("Dams Per County")

```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#3.3(2)

point_in_polygon(sf_dam, voroni, "id") %>% 
  plot_pip("Dams - Voronoi Pattern")
```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#3.3(3)

point_in_polygon(sf_dam, triangulate, "id") %>% 
  plot_pip("Dams - Triangulation Pattern")

```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#3.3(4)

point_in_polygon(sf_dam, sq_grid, "id") %>% 
  plot_pip("Dams - Grid")

```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#3.3(5)

point_in_polygon(sf_dam, hex_grid, "id") %>% 
  plot_pip("Dams - Hexagon")
```

# Question #4


```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
dfcreate = function(abbr, purpose){
  data_frame(abbr, purpose)}

dam_summary = bind_rows(
  dfcreate("I", "Irrigation"),
  dfcreate("H", "Hydroelectric"),
  dfcreate("C", "Flood Control"),
  dfcreate("N", "Navigation"),
  dfcreate("S", "Water Supply"),
  dfcreate("R", "Recreation"),
  dfcreate("P", "Fire Protection"),
  dfcreate("F", "Fish and Wildlife"),
  dfcreate("D", "Debris Control"),
  dfcreate("T", "Tailings"),
  dfcreate("G", "Grade Stabilization"),
  dfcreate("O", "Other"))

dam_freq <- strsplit(sf_dam$PURPOSES, split = "") %>%
  unlist() %>% 
  table() %>% 
  as.data.frame() %>% 
  setNames(c("abbr", "count")) %>% 
  left_join(dam_summary) %>% 
  mutate(lab = paste0(purpose, "\n(", abbr, ")"))
ggplot(data = dam_freq) +
  theme_dark()+
  geom_col(aes(x = reorder(lab, -count), y = count, fill = lab)) +
  labs(title = "Number of Dams Serving Each Purpose",
       x = "Dam Purpose",
       y = "# Dams")+
  theme(axis.text.x = element_text(angle = 90))


```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#4.1(1)

library(gghighlight)
  I_sf_dam <- sf_dam %>% 
  filter(grepl("I", sf_dam$PURPOSES) == TRUE)

point_in_polygon(sf_dam, hex_grid, "id") %>% 
  plot_pip("Areas With Most Dams Used For Irrigation") +
  gghighlight(n > (mean(n) + sd(n)))
```

>The geographic distribution of dams most used for irrigation are located mostly in central and eastern America. This distribution doesn't make sense to me because there are no data points showing in California where a lot of agriculture is grown. This could be due to California using other forms of irrigation other than dams such as groundwater. The dam distribution closely follows the outline of the Mississipi river. The Hexagon tessellation may impact my findings by not showing how the west may have more data points in specific tiles.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#4.1(2)

H_sf_dam <- sf_dam %>% 
  filter(grepl("H", sf_dam$PURPOSES) == TRUE)
point_in_polygon(H_sf_dam, hex_grid, "id") %>% 
  plot_pip("Areas With Most Dams Used For Hydro") +
  gghighlight(n > (mean(n) + sd(n)))
```

>The geographic distribution of dams most used for hydro power are located mostly in northern parts of America. This distribution makes sense to me because other parts of the country get their power in other ways such as from coal or natural gas fracking.  The hydropower distribution seems to be where there is a lot of water available; they are able to use excess water for power and flood control. The Hexagon tessellation may impact my findings by not showing how the west may have more data points in specific tiles.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#4.1(3)

S_sf_dam <- sf_dam %>% 
  filter(grepl("S", sf_dam$PURPOSES) == TRUE)
point_in_polygon(S_sf_dam, hex_grid, "id") %>% 
  plot_pip("Areas With Most Dams Used For Water Supply") +
  gghighlight(n > (mean(n) + sd(n)))
```

>The geographic distribution of dams most used for water supply are scattered across America. This distribution makes sense to me because water is a scarce resource and dams provide a reliable source of water that can be distributed. The Hexagon tessellation may impact my findings by not showing how the west may have more data points in specific tiles.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#4.1(4)

G_sf_dam <- sf_dam %>% 
  filter(grepl("N", sf_dam$PURPOSES) == TRUE)
point_in_polygon(G_sf_dam, hex_grid, "id") %>% 
  plot_pip("Areas With Most Dams Used For Grade Stabilization") +
  gghighlight(n > (mean(n) + sd(n)))
```

>The geographic distribution of dams most used for grade stabilization seems to be concentrated in the eastern United States. This distribution makes sense to me because it rains a lot on the east coast. There is a greater need for dam grade stabilization in the east than in the west where it doesn't rain as much and grade stabilization isn't as much of an issue. The Hexagon tessellation may impact my findings by not showing how the west may have more data points in specific tiles.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#extracredit

mis <- read_sf("~/Documents/github/geog-176A-labs/data/majorrivers_0_0") %>% 
  filter(SYSTEM == "Mississippi")
max_storage = dam2019 %>% 
  filter(HAZARD == "H") %>% 
  filter(!STATE %in% c("AK", "HI", "GU", "PR")) %>% 
  filter(PURPOSES == "C") %>% 
  group_by(STATE) %>% 
  slice_max(NID_STORAGE, n=1)

max_storage_labels <- max_storage %>% 
  select(DAM_NAME, NID_STORAGE, PURPOSES, YEAR_COMPLETED)
radius = max_storage %>% 
  mutate(radius = NID_STORAGE / 1500000) %>% 
  select(radius)

avector <- as.vector(radius$radius)
leaflet(data = max_storage) %>% 
  addProviderTiles(providers$CartoDB) %>% 
  addCircleMarkers(color = "purple", fillOpacity = 1, stroke = FALSE, popup = leafpop::popupTable(max_storage_labels, feature.id = FALSE), radius = avector) %>% 
  addPolylines(data = mis) %>% 
  addMeasure() %>% 
  addGraticule() %>% 
  addMiniMap()
```

